name: Pineus Tilu CI/CD DevSecOps

on:
  pull_request:
    branches: [ main, develop ]
  push:
    branches: [ main, develop ]

jobs:

  lint-test:
    name: Lint & Unit Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Cache NPM
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: ${{ runner.os }}-node-

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint

      - name: Run unit tests
        run: npm run test

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.1

      - name: Install Composer dependencies
        run: composer install --prefer-dist --no-interaction --no-progress

      - name: Run PHP Unit tests
        run: php artisan test || echo "No tests yet"

  docker-test:
    name: Build & Test Docker App
    runs-on: ubuntu-latest
    needs: lint-test
    services:
      db:
        image: mysql:5.7
        env:
          MYSQL_ROOT_PASSWORD: rootpassword
          MYSQL_DATABASE: laravel
        options: --health-cmd="mysqladmin ping -h localhost" --health-interval=10s --health-retries=5
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-docker-action@v3
      - run: docker-compose -f docker-compose.yml build app
      - run: docker-compose run --rm app bash -c "
            cp .env.example .env
            php artisan key:generate
            chmod -R 777 storage bootstrap/cache
            php artisan migrate --force
            php artisan db:seed --class=RoomSeeder --force
            php artisan test || echo 'No PHP tests yet'
        
  security-scan:
    name: Security Scan (Composer / NPM / ZAP)
    runs-on: ubuntu-latest
    needs: docker-test
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-docker-action@v3
      - name: Composer & NPM Audit
        run: |
          docker-compose run --rm app bash -c "
            composer audit --format=json || true
            npm audit --audit-level=moderate || true
          "
      - name: OWASP ZAP Baseline Scan
        run: |
          docker-compose -f docker-compose.yml up -d app db
          sleep 30
          docker run --network pineus-tilu-${{ github.run_id }}_default -i owasp/zap2docker-stable zap-baseline.py \
            -t http://app:80 -I

  build-deploy:
    name: Build & Deploy Docker App
    runs-on: ubuntu-latest
    needs: [docker-test, security-scan]
    if: "github.ref == 'refs/heads/main' && github.event_name == 'push'"
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-docker-action@v3
      - name: Login Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Build & Push Docker Images
        run: |
          docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/pineus-tilu-app:${{ github.sha }} .
          docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/pineus-tilu-app:latest .
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/pineus-tilu-app:${{ github.sha }}
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/pineus-tilu-app:latest
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            cd /opt/pineus-tilu
            docker-compose pull
            docker-compose down
            docker-compose up -d
            docker-compose exec -T app php artisan migrate --force
            curl -fsSL http://localhost/metrics.php || echo "App not responding"
