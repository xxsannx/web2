name: Deploy Production Check

on:
  workflow_dispatch: # Bisa dijalankan manual untuk testing

jobs:
  deploy-production:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script: |
            cd /opt/pineus-tilu || exit 1
            
            echo "üì• Pull latest code..."
            git pull origin main
            
            echo "üîÑ Start services..."
            sudo docker-compose up -d --build
            
            echo "‚è≥ Waiting for services..."
            sleep 10
            
            echo "üóÑÔ∏è Run migrations..."
            sudo docker-compose exec -T app php artisan migrate --force
            
            echo "‚ö° Clear caches..."
            sudo docker-compose exec -T app php artisan config:cache
            sudo docker-compose exec -T app php artisan route:cache
            sudo docker-compose exec -T app php artisan view:cache
            
            echo "üîç Check container status..."
            sudo docker-compose ps
